name: Test Rust

on:
  workflow_call:

jobs:
  rust:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download container image
      uses: actions/download-artifact@v4
      with:
        name: nvim-container

    - name: Load container image
      run: docker load < nvim-container.tar

    - name: Test Rust
      run: docker run --rm --cap-add=SYS_PTRACE iocanel/nvim make test_rust

    - name: Upload test artifacts on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs-rust
        path: |
          tests/rust/
          *.log
        retention-days: 7
