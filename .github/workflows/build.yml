name: Build and Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # Build container once for all language tests
  build-container:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build container with cache
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.ubuntu
        tags: iocanel/nvim
        load: true
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Save container image
      run: docker save iocanel/nvim > nvim-container.tar

    - name: Upload container image
      uses: actions/upload-artifact@v4
      with:
        name: nvim-container
        path: nvim-container.tar
        retention-days: 1

  # Language-specific test jobs
  test-java:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download container image
      uses: actions/download-artifact@v4
      with:
        name: nvim-container

    - name: Load container image
      run: docker load < nvim-container.tar

    - name: Test Java
      run: docker run --rm iocanel/nvim make test_java

    - name: Upload test artifacts on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs-java
        path: |
          tests/java/
          *.log
        retention-days: 7

  test-go:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download container image
      uses: actions/download-artifact@v4
      with:
        name: nvim-container

    - name: Load container image
      run: docker load < nvim-container.tar

    - name: Test Go
      run: docker run --rm iocanel/nvim make test_go

    - name: Upload test artifacts on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs-go
        path: |
          tests/go/
          *.log
        retention-days: 7

  test-python:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download container image
      uses: actions/download-artifact@v4
      with:
        name: nvim-container

    - name: Load container image
      run: docker load < nvim-container.tar

    - name: Test Python
      run: docker run --rm iocanel/nvim make test_python

    - name: Upload test artifacts on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs-python
        path: |
          tests/python/
          *.log
        retention-days: 7

  test-javascript:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download container image
      uses: actions/download-artifact@v4
      with:
        name: nvim-container

    - name: Load container image
      run: docker load < nvim-container.tar

    - name: Test JavaScript
      run: docker run --rm iocanel/nvim make test_javascript

    - name: Upload test artifacts on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs-javascript
        path: |
          tests/javascript/
          *.log
        retention-days: 7

  test-typescript:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download container image
      uses: actions/download-artifact@v4
      with:
        name: nvim-container

    - name: Load container image
      run: docker load < nvim-container.tar

    - name: Test TypeScript
      run: docker run --rm iocanel/nvim make test_typescript

    - name: Upload test artifacts on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs-typescript
        path: |
          tests/typescript/
          *.log
        retention-days: 7

  test-rust:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download container image
      uses: actions/download-artifact@v4
      with:
        name: nvim-container

    - name: Load container image
      run: docker load < nvim-container.tar

    - name: Test Rust
      run: docker run --rm iocanel/nvim make test_rust

    - name: Upload test artifacts on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs-rust
        path: |
          tests/rust/
          *.log
        retention-days: 7

  test-c:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download container image
      uses: actions/download-artifact@v4
      with:
        name: nvim-container

    - name: Load container image
      run: docker load < nvim-container.tar

    - name: Test C
      run: docker run --rm iocanel/nvim make test_c

    - name: Upload test artifacts on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs-c
        path: |
          tests/c/
          *.log
        retention-days: 7

  # Aggregation job - only runs if all language tests pass
  all-tests-passed:
    runs-on: ubuntu-latest
    needs: [test-java, test-go, test-python, test-javascript, test-typescript, test-rust, test-c]
    steps:
    - name: All tests completed successfully
      run: echo "âœ… All language tests passed successfully!"
